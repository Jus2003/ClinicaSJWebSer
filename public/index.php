<?php
require __DIR__ . '/../vendor/autoload.php';

use Slim\Factory\AppFactory;

// Configurar zona horaria
date_default_timezone_set('America/Guayaquil');

// Iniciar sesiones
session_start();

// Crear la aplicaci√≥n Slim
$app = AppFactory::create();

// üîß RESTAURAR ESTA L√çNEA:
$app->setBasePath('/citas-medicas-api/public');

// Middleware para parsing del body JSON
$app->addBodyParsingMiddleware();

// CORS MEJORADO PARA NGROK
$app->add(function ($request, $handler) {
    $response = $handler->handle($request);
    return $response
        ->withHeader('Access-Control-Allow-Origin', '*')
        ->withHeader('Access-Control-Allow-Headers', 'X-Requested-With, Content-Type, Accept, Origin, Authorization, ngrok-skip-browser-warning, User-Agent')
        ->withHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, PATCH, OPTIONS')
        ->withHeader('Access-Control-Allow-Credentials', 'true')
        ->withHeader('Access-Control-Max-Age', '3600')
        ->withHeader('Vary', 'Origin');
});

// üîß ENDPOINT ESPECIAL PARA BYPASS DE NGROK
$app->get('/bypass-test', function ($request, $response) {
    // Headers especiales para navegadores
    $response = $response
        ->withHeader('Access-Control-Allow-Origin', '*')
        ->withHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        ->withHeader('Access-Control-Allow-Headers', 'Content-Type, Accept')
        ->withHeader('Content-Type', 'application/json')
        ->withHeader('Cache-Control', 'no-cache');
    
    $data = [
        'status' => 200,
        'success' => true,
        'message' => 'Bypass test funcionando ‚úÖ',
        'timestamp' => time(),
        'ngrok_ready' => true
    ];
    
    $response->getBody()->write(json_encode($data));
    return $response;
});

// üîß ENDPOINT DE LOGIN ESPECIAL PARA NAVEGADOR
$app->post('/browser-login', function ($request, $response) {
    // Headers especiales
    $response = $response
        ->withHeader('Access-Control-Allow-Origin', '*')
        ->withHeader('Access-Control-Allow-Methods', 'POST, OPTIONS')
        ->withHeader('Access-Control-Allow-Headers', 'Content-Type, Accept')
        ->withHeader('Content-Type', 'application/json');
    
    $data = $request->getParsedBody();
    
    // Simulaci√≥n de login para prueba
    if (empty($data['usuario']) || empty($data['password'])) {
        $result = [
            'status' => 400,
            'success' => false,
            'message' => 'Usuario y contrase√±a requeridos'
        ];
    } else {
        $result = [
            'status' => 200,
            'success' => true,
            'message' => 'Login de prueba exitoso',
            'data' => [
                'usuario' => [
                    'nombre' => 'Usuario',
                    'apellido' => 'Prueba',
                    'email' => 'test@test.com',
                    'rol' => 'Administrador'
                ]
            ]
        ];
    }
    
    $response->getBody()->write(json_encode($result));
    return $response;
});

// MANEJAR PETICIONES OPTIONS (PREFLIGHT)
$app->options('/{routes:.+}', function ($request, $response, $args) {
    return $response;
});

// Middleware de errores
$app->addErrorMiddleware(true, true, true);

// ============================================
// RUTAS PRINCIPALES
// ============================================

// Ruta de bienvenida - SOLO UNA VEZ
$app->get('/', function ($request, $response) {
    $data = [
        'mensaje' => 'üéâ API Citas M√©dicas - Sistema Completo',
        'version' => '1.0.0',
        'php_version' => phpversion(),
        'servidor' => 'WAMP Server',
        'fecha_hora' => date('Y-m-d H:i:s'),
        'ngrok_ready' => true, // üëà Indicador para frontend
        'endpoints_disponibles' => [
            'POST /auth/login' => 'Iniciar sesi√≥n',
            'POST /auth/logout' => 'Cerrar sesi√≥n',
            'GET /auth/perfil' => 'Obtener perfil del usuario',
            'POST /auth/olvido-password' => 'Recuperar contrase√±a',
            'PUT /perfil/cambiar-password' => 'Cambiar contrase√±a (requiere sesi√≥n)',
            'GET /pacientes/buscar-cedula/{cedula}' => 'Buscar paciente por c√©dula',
            'GET /pacientes/historial-completo/{id_paciente}' => 'Historial cl√≠nico completo',
            'GET /pacientes/historial-cedula/{cedula}' => 'Historial cl√≠nico completo por c√©dula',
            'GET /pacientes/historial-lista' => 'Lista de pacientes para historial m√©dico (seg√∫n rol)',
            'GET /citas/especialidad/{id_especialidad}/medico/{id_medico}' => 'Citas por especialidad y m√©dico',
            'GET /citas/medico/{id_medico}' => 'Citas por m√©dico',
            'GET /citas/fechas?inicio=YYYY-MM-DD&fin=YYYY-MM-DD' => 'Citas por rango de fechas',
            'GET /especialidades/listar' => 'Lista de especialidades activas',
            'GET /medicos/listar' => 'Lista de m√©dicos activos',
            'GET /medicos/especialidad/{id_especialidad}' => 'M√©dicos por especialidad',
            'GET /citas/paciente/{id_paciente}' => 'Citas de un paciente espec√≠fico',
            'GET /citas/todas' => 'Todas las citas (admin/recepcionista)',
            'POST /citas/consultar-por-id' => 'Consultar cita espec√≠fica por ID (JSON)',
            'POST /citas/consultar-por-fechas' => 'Consultar citas por rango de fechas (JSON)',
            'POST /pacientes/buscar-historial-id' => 'Buscar historial cl√≠nico por ID (JSON)',
            'POST /pacientes/buscar-historial-cedula' => 'Buscar historial cl√≠nico por c√©dula (JSON)',
            'POST /citas/buscar-por-filtros' => 'Buscar citas por especialidad/m√©dico (JSON)',
            'POST /citas/buscar-por-id' => 'Buscar cita espec√≠fica por ID (JSON)',
            'POST /citas/buscar-por-medico' => 'Buscar todas las citas de un m√©dico por ID (JSON)',
            'POST /citas/buscar-fechas-usuario' => 'Citas por rango de fechas + paciente/m√©dico (JSON)',

            'GET /test' => 'Prueba de conectividad'
        ],
        'ejemplos' => [
            'login' => [
                'url' => '/auth/login',
                'method' => 'POST',
                'body' => ['usuario' => 'admin', 'password' => 'admin123']
            ],
            'cambiar_password' => [
                'url' => '/perfil/cambiar-password',
                'method' => 'PUT',
                'body' => [
                    'password_actual' => 'password_actual',
                    'password_nueva' => 'nueva_password',
                    'confirmar_password' => 'nueva_password'
                ]
            ],
            'olvido_password' => [
                'url' => '/auth/olvido-password',
                'method' => 'POST',
                'body' => ['email' => 'usuario@email.com']
            ]
        ]
    ];
    $response->getBody()->write(json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    return $response->withHeader('Content-Type', 'application/json; charset=utf-8');
});

// üîß RUTA DE TEST MEJORADA
$app->get('/test', function ($request, $response) {
    $data = [
        'status' => 200,
        'success' => true,
        'message' => 'API funcionando correctamente ‚úÖ',
        'data' => [
            'timestamp' => time(),
            'fecha_hora' => date('Y-m-d H:i:s'),
            'session_active' => isset($_SESSION['user_id']) ? 'S√≠' : 'No',
            'user_id' => $_SESSION['user_id'] ?? null,
            'cors_enabled' => true,
            'ngrok_compatible' => true
        ]
    ];
    $response->getBody()->write(json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    return $response->withHeader('Content-Type', 'application/json');
});

// Test endpoint para debuggear
$app->get('/debug/paciente-test', function ($request, $response) {
    try {
        // Test b√°sico de conexi√≥n a BD
        $database = new App\Config\Database();
        $db = $database->getConnection();
        
        $sql = "SELECT COUNT(*) as total FROM usuarios WHERE id_rol = 4";
        $stmt = $db->prepare($sql);
        $stmt->execute();
        $total = $stmt->fetch();
        
        $result = [
            'status' => 200,
            'success' => true,
            'message' => 'Test de conexi√≥n exitoso',
            'data' => [
                'total_pacientes' => $total['total'],
                'clase_paciente_existe' => class_exists('App\Models\Paciente'),
                'metodos_disponibles' => class_exists('App\Models\Paciente') ? 
                    get_class_methods('App\Models\Paciente') : 'Clase no existe'
            ]
        ];
        
        $response->getBody()->write(json_encode($result, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        return $response->withHeader('Content-Type', 'application/json');
        
    } catch (\Exception $e) {
        $result = [
            'status' => 500,
            'success' => false,
            'message' => 'Error en test: ' . $e->getMessage(),
            'data' => [
                'trace' => $e->getTraceAsString()
            ]
        ];
        $response->getBody()->write(json_encode($result, JSON_UNESCAPED_UNICODE));
        return $response->withHeader('Content-Type', 'application/json')->withStatus(500);
    }
});

// ============================================
// INCLUIR RUTAS EXTERNAS
// ============================================

// Incluir rutas de autenticaci√≥n
require __DIR__ . '/../src/Routes/auth.php';

// Incluir rutas de perfil
require __DIR__ . '/../src/Routes/perfil.php';

require __DIR__ . '/../src/Routes/pacientes.php';

require __DIR__ . '/../src/Routes/citas.php';

// Incluir rutas de especialidades
require __DIR__ . '/../src/Routes/especialidades.php';

// Incluir rutas de m√©dicos
require __DIR__ . '/../src/Routes/medicos.php';

require __DIR__ . '/../src/Routes/triaje.php';

require __DIR__ . '/../src/Routes/recetas.php';

require_once __DIR__ . '/../src/Routes/historial.php';

// ============================================
// EJECUTAR LA APLICACI√ìN
// ============================================
$app->run();
?>